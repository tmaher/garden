#!/opt/node/bin/node

var https = require('https');
sprintf = require('sprintf').sprintf;
err_log = function(){ process.stderr.write(sprintf.apply(null, arguments)); };
var tweet_markup = require('tweet_markup').markup;


var digest_tweets = function (t){
    var creation_out = new Date(Date.parse(t["created_at"])).toString();
    var out = creation_out + "\n" + t["text"] + "\n\n";

    return out;
};

function get_all_limit(screen_name, limit, user_cb) {
    var all_tweets = [];

    var maxfetch = 6;
    var currfetch = 0;
    var options = { host: 'api.twitter.com' };
    var base_path = "/1/statuses/user_timeline.json" +
        "?screen_name=" + screen_name +
        "&trim_user=true" +
        "&include_rts=false";
    var currpage = 1;

    function get_all_helper(){
        options["path"] = base_path + "&page=" + currpage++;
        var req = https.get(options, function(res) {
            var all_chunks = "";
            res.on("data", function(c){ all_chunks += c;  });
            
            var finished = function(){
                currfetch += 1;
                var these_tweets = JSON.parse(all_chunks);
                if(these_tweets.length < 1){ return; }

                var oldest_tweet = these_tweets.pop();
                var oldest_ts = Date.parse(oldest_tweet["created_at"]);
                these_tweets.push(oldest_tweet);
                if((oldest_ts > limit) &&
                   (these_tweets.length > 0) &&
                   (currfetch < maxfetch)){
                    all_tweets = all_tweets.concat(these_tweets);
                    get_all_helper();
                } else {
                    err_log("fetched tweets across %d pages\n", currfetch);
                    old_date = new Date(oldest_ts).toLocaleString();
                    limit_date = new Date(limit).toLocaleString();
                    err_log("%s (oldest tweet)\n%s (tweet limit)\n",
                            old_date, limit_date);
                    
                    var is_oldest;
                    do {
                        is_oldest = these_tweets.pop();
                        o_ts = Date.parse(is_oldest["created_at"]);
                    } while(o_ts <= limit && these_tweets.length >= 1);

                    if(o_ts > limit){ these_tweets.push(is_oldest); }

                    all_tweets = all_tweets.concat(these_tweets);
                    //process_tweets(all_tweets);
                    user_cb(all_tweets);
                }
            };
    
            res.on("end", finished);
            res.on("close", finished);
        });
        
        req.end();
    }

    get_all_helper();
}

exports.get_all_limit = get_all_limit;
