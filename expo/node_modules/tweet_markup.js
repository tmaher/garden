var domain_normalize = function (text, domains){
    for(d in domains){
        d = domains[d].replace(/\./g, "\\.");
        rp =
            new RegExp("(^|[ \t])("+d+")((?::[1-9][0-9]{0,5}){0,1})(\/(?:[0-9A-Za-z\-\._~]|[:\/\?\#\[\]\@]|[!\$\&\'\(\)\*\+,;=]|\%[0-9a-fA-F])*)([ \t]|$)", "g");
        text = text.replace(rp, "$1http://$2$3/$4$5");
    }
    return text;
}

var trailing_path_normalize = function(text){
    p = /((?:^|[ \t])http(?:s){0,1}:\/\/[0-9A-Za-z][0-9A-Za-z\-_\.]*)($|[ \t])/g;
    return text.replace(p, "$1/$2");
}

var anchor_tag_normalize = function(t){
    var urlpat = /([ \t]|^)(http(?:s){0,1}):\/\/([a-zA-Z-0-9](?:[a-zA-Z0-9_\-\.])+)((?:\:[0-9]{1,5}){0,1})(\/(?:[0-9A-Za-z\-\._~]|[:\/\?\#\[\]\@]|[!\$\&\'\(\)\*\+,;=]|\%[0-9a-fA-F])*)([ \t]|$)/g;
    return t.replace(urlpat, '$1<a href="$2://$3$4$5">$2://$3$4$5</a>$6');
}

var markup = function (t){
    var ts_out = new Date(Date.parse(t["created_at"])).toString();
    var text = t["text"];

    text = domain_normalize(text, ["bit.ly", "t.co"]);
    text = trailing_path_normalize(text);
    text = anchor_tag_normalize(text);

    var out = '<div class="tweet-ts">' + ts_out + "</div><br />\n" +
        '<div class="tweet-text">' + text + "</div><br />< br/>\n";

    return out;
};

exports.markup = markup;
