sprintf = require('sprintf').sprintf;

var domain_normalize = function (text, domains){
    for(d in domains){
        d = domains[d].replace(/\./g, "\\.");
        rp =
            new RegExp("(^|[ \t])("+d+")((?::[1-9][0-9]{0,5}){0,1})(\/(?:[0-9A-Za-z\-\._~]|[:\/\?\#\[\]\@]|[!\$\&\'\(\)\*\+,;=]|\%[0-9a-fA-F])*)([ \t]|$)", "g");
        text = text.replace(rp, "$1http://$2$3$4$5");
    }
    return text;
}

var trailing_path_normalize = function(text){
    p = /((?:^|[ \t])http(?:s){0,1}:\/\/[0-9A-Za-z][0-9A-Za-z\-_\.]*)($|[ \t])/g;
    return text.replace(p, "$1/$2");
}

var anchor_tag_normalize = function(t){
    var urlpat = /([ \t]|^)(http(?:s){0,1}):\/\/([a-zA-Z-0-9](?:[a-zA-Z0-9_\-\.])+)((?:\:[0-9]{1,5}){0,1})(\/(?:[0-9A-Za-z\-\._~]|[:\/\?\#\[\]\@]|[!\$\&\'\(\)\*\+,;=]|\%[0-9a-fA-F])*)([ \t]|$)/g;
    return t.replace(urlpat, '$1<a href="$2://$3$4$5">$2://$3$4$5</a>$6');
}

var html_escape = function(t){
    //t = t.replace(/&(?!(?:[a-zA-Z][a-zA-Z]{1,9}[1-4]{0,2}|#[0-9]{2,7}|#x[0-9a-f]{2-7});)/g,
    t = t.replace(/&(?!(?:amp|lt|gt|quot|apos|#39|#x27);)/g,
                  "&amp;");
    t = t.replace(/</g, "&lt;");
    t = t.replace(/>/g, "&gt;");
    t = t.replace(/'/g, "&#39;");
    return t;
}

var screen_name_normalize = function(t){
    var p = /(^|[ \t,.;\-])@([0-9a-zA-Z_]{1,15})($|[ \t,.;\-])/g;
    return t.replace(p, "$1<a href=\"https://twitter.com/#!/$2\">@$2</a>$3");
}

var markup = function (t){
    var ts = new Date(Date.parse(t["created_at"])).toString();
    var url = sprintf("https://twitter.com/#!/%s/status/%s",
                      t['user']['id_str'], t['id_str']);
    var ts_out = sprintf('<a href="%s" target="_blank">%s</a>', url, ts);
    var text = t["text"];

    text = domain_normalize(text, ["bit.ly", "t.co"]);
    text = trailing_path_normalize(text);
    text = html_escape(text);
    text = anchor_tag_normalize(text);
    text = screen_name_normalize(text);

    var out = '<p><div class="tweet-ts">' + ts_out + "</div>" +
        '<div class="tweet-text">' + text + "</div></p>\n";

    return out;
};

exports.markup = markup;
